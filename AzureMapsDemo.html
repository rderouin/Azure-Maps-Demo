<!DOCTYPE html>
<html lang="en">
<head>
    <title>Azure Maps Demo - Web SDK Demo for Polyglot Layering</title>
    <meta charset="UTF-8" />


    <!-- Ensures that Internet Explorer and Edge uses the latest version and doesn't emulate an older version -->
    <meta http-equiv="x-ua-compatible" content="IE=Edge">
    <!-- Ensures the web page looks good on all screen sizes. -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="This is a demo to test polygon layering using Azure Maps Web SDK" />
    <meta version="1.0" />

    <!-- Reference to the Azure Maps Map control javascript and css files -->
    <link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" rel="stylesheet" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
     <!-- Load runtime env first -->
    <script src="env.js"></script>

    <!-- Reference to the Azure Maps services module JavaScript file. -->
     <script src="https://atlas.microsoft.com/sdk/javascript/service/2/atlas-service.min.js"></script>

    <!-- Maps SDK variables or config -->
     <script>
        var map, datasource, popup, searchInput, resultsPanel, searchInputLength, centerMapOnResults;
        // Configurable URL for the GeoJSON data. 
        // Update this value as needed for your environment.
        const geoJsonUrl = 'http://127.0.0.1:5500/BASFGeoJSON.json'; // Local development URL

        // Your Azure Maps client id for accessing your Azure Maps account.
        //import 'dotenv/config'; // Ensure you have dotenv installed and configured
        const azureMapsClientId      = window._env_.AZURE_MAPS_CLIENT_ID;
        const azureMapsSubscriptionKey = window._env_.AZURE_MAPS_SUBSCRIPTION_KEY;

        // URL to your authentication service that retrieves an Microsoft Entra ID Token.
        var tokenServiceUrl = 'https://samples.azuremaps.com/api/GetAzureMapsToken';

        // The minimum number of characters needed in the search input before a search is performed.
        var minSearchInputLength = 3;

        // The number of ms between key strokes to wait before performing a search.
        var keyStrokeDelay = 60;

        //Initialize map control
        function InitMap()
        {
            map = new atlas.Map('myMap', {
                    center: [-73.97, 40.78],
                    zoom: 11,
                    view: "Auto",
                    language: 'en-US',
                    authOptions: {
                        authType: 'subscriptionKey',
                        subscriptionKey: azureMapsSubscriptionKey
                    }
            });

            // Wait until the map resources are ready and then add controls to the map.
            map.events.add('ready',function(){
                //Create zoom control and add it to the map.
                enableMapControls(map);
                enableCoordinateDisplay(map)

                //Create a data source and add it to the map.
                dataSource = new atlas.source.DataSource();
                map.sources.add(dataSource);

                // Fetch GeoJSON from file
                fetch("BASFGeoJSON.json")
                    .then(function (response) {
                    if (!response.ok) {
                        throw new Error("Network response was not ok " + response.statusText);
                    }
                    return response.json();
                    })
                    .then(function (geojsonData) {
                    // Add features to the data source
                    dataSource.add(geojsonData);

                    // Create a polygon layer to render the geometry
                    var polygonLayer = new atlas.layer.PolygonLayer(dataSource, null, {
                        fillColor: "rgba(0, 128, 255, 0.5)",
                        strokeColor: "#0055aa",
                        strokeWidth: 2
                    });
                    
                    //Create a line layer for greater control of rendering the outline of the polygon
                    var lineLayer = new atlas.layer.LineLayer(dataSource, 'myLineLayer', {
                        strokeColor: 'green', // black outline
                        strokeWidth: 5 // 2px width
                    }); 
                    // Add the layer to the map
                    //map.layers.add(polygonLayer);
                    //create and add a polygon layer to render hte poloygon to the map
                    map.layers.add([polygonLayer, lineLayer]);

                    // Optional: Zoom to the data bounds
                    var bbox = atlas.data.BoundingBox.fromData(geojsonData);
                    map.setCamera({ bounds: bbox, padding: 50 });
                    })
                    .catch(function (error) {
                    console.error("Error loading GeoJSON:", error);
                    });

            });
        }

        //Enable Azure map controls
        function enableMapControls(mapInstance){
            // Add zoom control to the map.
            mapInstance.controls.add(new atlas.control.ZoomControl(), {
                position: 'top-right'
            });

            // Add a compass control to the map.
            mapInstance.controls.add(new atlas.control.CompassControl(), {
                position: 'top-right'
            });

        }

        //Show coordinates as popup when hovering on the map
        function enableCoordinateDisplay(mapInstance) {
            const coordDisplay = document.getElementById('coordDisplay');
            
            map.events.add('mousemove', (e) =>{
                const position = e.position;
                if(position) {
                    const lat = position[1];
                    const lon = position[0];

                    coordDisplay.innerText = `Latitude: ${lat.toFixed(4)}, Longitude: ${lon.toFixed(4)}`;
                }
            });

        }


     </script>
<style>
     html, body {
         margin: 0;
     }

     #myMap {
         height: 100vh;
         width: 100vw;
     }
     #coordDisplay {
         position: absolute;
         bottom: 10px;
         left: 10px;
         background: white;
         padding: 6px 10px;
         font-family: sans-serif;
         font-size: 13px;
         border-radius: 4px;
         box-shadow: 0 1px 4px rgba(0,0,0,0.3);
         z-index: 1000;
     }
     
 </style>

</head>
<body onload="InitMap()">
    <div id="myMap"></div>
    <div id="coordDisplay">
        Hover over the map to see coordinates
    </div>
</body>
</html>